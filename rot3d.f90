SUBROUTINE director3d(dr,t0,t,dt,ddt)
  IMPLICIT REAL(8) (a-h,o-z)
  REAL(8),DIMENSION(5001)::v
  REAL(8),DIMENSION(3)::dr,t0,t
  REAL(8),DIMENSION(3,3),OPTIONAL::dt
  REAL(8),DIMENSION(3,3,3),OPTIONAL::ddt
  IF(rnorm2(3,dr).LE.epsmach())dr=1.0d-6
  v(330)=dr(1)*dr(2)
  v(329)=dr(1)*dr(3)
  v(327)=dr(2)*dr(3)
  v(36)=2d0*dr(1)
  v(23)=dr(1)**2
  v(37)=2d0*dr(2)
  v(13)=dr(2)**2
  v(97)=-v(13)-v(23)
  v(346)=t0(3)*v(97)
  v(38)=2d0*dr(3)
  v(14)=dr(3)**2
  v(314)=v(13)+v(14)+v(23)
  v(318)=sqrt(v(314))
  v(316)=1d0/v(318)
  v(313)=v(316)/2d0
  v(123)=v(313)*v(38)
  v(333)=dr(3)*v(123)
  v(133)=v(123)/2d0
  v(120)=v(313)*v(37)
  v(132)=v(120)/2d0
  v(118)=v(314)
  v(122)=-(v(120)/v(118))
  v(317)=v(122)/2d0
  v(126)=v(317)*v(38)
  v(117)=v(313)*v(36)
  v(131)=v(117)/2d0
  v(119)=-(v(117)/v(118))
  v(315)=v(119)/2d0
  v(128)=v(315)*v(37)
  v(125)=v(315)*v(38)
  v(86)=-v(14)-v(23)
  v(345)=t0(2)*v(86)
  v(77)=-v(13)-v(14)
  v(341)=t0(1)*v(77)
  v(39)=v(316)
  v(130)=v(315)*v(36)+v(39)
  v(129)=v(317)*v(37)+v(39)
  v(127)=-((v(133)*v(38))/v(118))+v(39)
  v(12)=v(318)
  v(338)=-(dr(1)/v(12))
  v(337)=dr(2)/v(12)
  v(334)=-(dr(3)/v(12))
  v(319)=dsin(v(12))
  v(168)=-(v(123)*v(319))
  v(167)=v(120)*v(319)
  v(166)=-(v(117)*v(319))
  v(141)=1d0/v(12)**3
  v(320)=(-2d0)*v(141)
  v(148)=v(123)*v(320)
  v(146)=v(117)*v(320)
  v(58)=v(12)/2d0
  v(134)=dcos(v(58))
  v(137)=v(133)*v(134)
  v(136)=v(132)*v(134)
  v(135)=v(131)*v(134)
  v(59)=dsin(v(58))
  v(321)=(-8d0)*v(141)*v(59)
  v(155)=v(137)*v(321)
  v(153)=v(136)*v(321)
  v(150)=v(135)*v(321)
  v(57)=(v(59)*v(59))
  v(143)=(12d0*v(57))/v(12)**4
  v(144)=v(120)*v(143)+v(153)
  v(142)=v(117)*v(143)+v(150)
  v(61)=(-4d0)*v(141)*v(57)
  v(47)=1d0/v(12)**2
  v(339)=v(117)*v(47)
  v(332)=-(dr(2)*v(47))
  v(322)=2d0*v(47)
  v(206)=dr(1)*v(339)
  v(188)=v(333)*v(47)
  v(335)=2d0*v(188)
  v(152)=v(134)*v(322)
  v(149)=v(322)*v(59)
  v(323)=-(v(149)*v(59))
  v(154)=v(136)*v(152)+v(153)+v(132)*v(323)
  v(326)=v(144)+v(154)
  v(151)=v(150)+v(135)*v(152)+v(131)*v(323)
  v(325)=v(142)+v(151)
  v(62)=v(134)*v(149)
  v(324)=v(61)+v(62)
  v(186)=v(123)*v(62)
  v(183)=v(120)*v(62)
  v(181)=v(117)*v(62)
  v(162)=v(130)*v(324)+v(117)*v(325)
  v(163)=v(162)*v(327)
  v(161)=v(129)*v(324)+v(120)*v(326)
  v(160)=v(128)*v(324)+v(120)*v(325)
  v(159)=v(123)*(v(123)*v(143)+v(137)*v(152)+2d0*v(155)+v(133)*v(323))+v(127)*v(324)
  v(158)=v(126)*v(324)+v(123)*v(326)
  v(157)=v(125)*v(324)+v(123)*v(325)
  v(64)=v(186)+v(123)*v(61)
  v(282)=-(v(38)*v(64))
  v(226)=dr(3)*v(64)
  v(222)=dr(2)*v(64)
  v(328)=2d0*v(222)
  v(231)=v(161)*v(327)+v(328)
  v(230)=v(159)*v(327)+v(328)
  v(213)=-(v(36)*v(64))
  v(210)=-v(328)
  v(63)=v(183)+v(120)*v(61)
  v(262)=-(v(37)*v(63))
  v(220)=dr(2)*v(63)
  v(60)=v(181)+v(117)*v(61)
  v(340)=dr(1)*v(60)
  v(243)=-(v(36)*v(60))
  v(217)=dr(3)*v(60)
  v(250)=-v(213)
  v(238)=-v(213)
  v(228)=v(250)+v(162)*v(329)
  v(225)=v(238)+v(159)*v(329)
  v(216)=dr(2)*v(60)
  v(331)=2d0*v(216)
  v(223)=v(162)*v(330)+v(331)
  v(219)=v(161)*v(330)+v(331)
  v(208)=-v(331)
  v(165)=v(216)+v(157)*v(327)
  v(164)=v(217)+v(160)*v(327)
  v(65)=dr(3)*v(216)
  v(44)=dcos(v(12))
  v(172)=v(120)*v(166)+v(128)*v(44)
  v(171)=v(123)*v(168)+v(127)*v(44)
  v(169)=v(123)*v(166)+v(125)*v(44)
  v(46)=v(123)*v(44)
  v(185)=v(46)/v(12)
  v(177)=v(332)*v(46)
  v(45)=v(120)*v(44)
  v(197)=-(v(45)/v(12))
  v(195)=v(332)*v(45)
  v(43)=v(117)*v(44)
  v(205)=-(v(43)/v(12))
  v(182)=v(181)+v(205)
  v(18)=v(319)
  v(336)=v(18)*v(47)
  v(199)=dr(1)*v(151)+v(62)
  v(193)=v(18)*v(333)
  v(192)=dr(3)*v(336)
  v(194)=(-2d0)*v(185)+2d0*v(186)+v(127)*v(192)+v(148)*v(193)+v(171)*v(334)+v(335)*v(46)
  v(190)=v(182)+v(125)*v(192)+v(146)*v(193)+v(169)*v(334)+v(335)*v(43)
  v(175)=v(195)-dr(2)*v(167)*v(320)-v(62)
  v(174)=-(dr(2)*v(151))
  v(54)=-(dr(2)*v(336))
  v(198)=-v(183)+v(120)*(v(175)+v(195))-2d0*v(197)+v(337)*(-(v(120)*v(167))+v(129)*v(44))+v(129)*v(54)
  v(196)=v(120)*v(174)-v(182)+v(117)*v(195)+v(172)*v(337)+v(128)*v(54)
  v(180)=dr(2)*(v(148)*v(168)+v(171)/v(12))+2d0*v(123)*v(177)+v(127)*v(54)
  v(179)=v(123)*v(175)+v(120)*v(177)+v(185)+v(337)*(-(v(123)*v(167))+v(126)*v(44))+v(126)*v(54)
  v(178)=v(123)*v(174)+v(117)*v(177)+v(169)*v(337)+v(125)*v(54)
  v(55)=dr(2)*v(185)+v(123)*v(54)
  v(52)=-(v(18)/v(12))
  v(56)=-(dr(3)*v(185))+v(18)*v(188)+v(52)
  v(53)=-(dr(2)*v(197))-v(52)+v(120)*v(54)
  v(49)=dr(1)*v(336)
  v(207)=v(182)+v(117)*v(199)+v(205)+v(206)*v(43)+v(338)*(v(117)*v(166)+v(130)*v(44))+v(130)*v(49)
  v(203)=v(197)+v(120)*v(199)+v(172)*v(338)+v(206)*v(45)+v(128)*v(49)
  v(202)=-v(185)+v(123)*v(199)+dr(1)*(-(v(169)/v(12))+v(339)*v(46))+v(125)*v(49)
  v(51)=-(dr(1)*v(185))+v(123)*v(49)
  v(50)=dr(1)*v(197)+v(120)*v(49)
  v(48)=dr(1)*v(205)+v(117)*v(49)+v(52)
  v(16)=-v(323)
  v(229)=v(16)+v(220)+v(226)+v(158)*v(327)
  v(215)=v(16)+v(340)
  v(224)=v(215)+v(226)+v(157)*v(329)
  v(218)=v(215)+v(220)+v(160)*v(330)
  v(211)=(-2d0)*v(16)
  v(214)=v(211)+v(282)
  v(343)=v(214)+v(282)
  v(212)=v(211)+v(243)
  v(344)=v(212)+v(243)
  v(209)=v(211)+v(262)
  v(342)=v(209)+v(262)
  v(101)=-(v(16)*v(37))
  v(96)=-(v(16)*v(36))
  v(93)=-(v(16)*v(38))
  v(73)=dr(1)*v(16)
  v(74)=dr(1)*v(220)+v(73)
  v(71)=dr(2)*v(16)
  v(72)=dr(2)*v(340)+v(71)
  v(70)=dr(1)*v(226)+v(73)
  v(68)=dr(3)*v(16)
  v(69)=v(329)*v(60)+v(68)
  v(67)=dr(3)*v(222)+v(71)
  v(66)=dr(3)*v(220)+v(68)
  v(29)=dr(2)*v(68)
  v(26)=dr(1)*v(68)
  v(20)=dr(1)*v(71)
  v(293)=t0(3)*(v(163)+v(196))+t0(2)*(-v(178)+v(218))+t0(1)*(v(208)+v(160)*v(77))
  v(294)=t0(2)*(v(163)+v(190))+t0(3)*(v(178)+v(224))+t0(1)*(-v(238)+v(157)*v(77))
  v(296)=t0(3)*(v(164)+v(203))+t0(1)*(v(178)+v(218))+t0(2)*(-v(331)+v(160)*v(86))
  v(297)=t0(1)*(v(163)-v(190))+t0(3)*(v(165)+v(202))+t0(2)*(v(213)-v(250)+v(157)*v(86))
  v(299)=t0(1)*(v(163)-v(196))+t0(2)*(v(164)-v(203))+t0(3)*(2d0*v(208)+v(160)*v(97))
  v(300)=t0(2)*(v(165)-v(202))+t0(1)*(-v(178)+v(224))+t0(3)*(v(213)+v(157)*v(97))
  v(302)=t0(3)*(v(165)+v(179))+t0(2)*(v(164)-v(180))+t0(1)*(2d0*v(210)+v(158)*v(77))
  v(304)=t0(1)*(v(164)+v(180))+t0(3)*(-v(178)+v(229))+t0(2)*(v(210)+v(158)*v(86))
  v(306)=t0(1)*(v(165)-v(179))+t0(2)*(v(178)+v(229))+t0(3)*(v(210)+v(158)*v(97))
  t(1)=t0(2)*(v(168)+v(20))+t0(3)*(v(167)+v(26))+t0(1)*(1d0+v(16)*v(77))
  t(2)=t0(1)*(-v(168)+v(20))+t0(3)*(v(166)+v(29))+t0(2)*(1d0+v(16)*v(86))
  t(3)=t0(1)*(-v(167)+v(26))+t0(2)*(-v(166)+v(29))+t0(3)*(1d0+v(16)*v(97))
  if(present(dt))then
     dt(1,1)=v(341)*v(60)+t0(3)*(-v(50)+v(69))+t0(2)*(v(51)+v(72))
     dt(1,2)=t0(3)*(v(53)+v(65))+t0(2)*(-v(55)+v(74))+t0(1)*(v(101)+v(63)*v(77))
     dt(1,3)=t0(2)*(v(56)+v(65))+t0(3)*(v(55)+v(70))+t0(1)*(v(64)*v(77)+v(93))
     dt(2,1)=t0(3)*(v(48)+v(65))+t0(1)*(-v(51)+v(72))+t0(2)*(v(60)*v(86)+v(96))
     dt(2,2)=v(345)*v(63)+t0(3)*(v(50)+v(66))+t0(1)*(v(55)+v(74))
     dt(2,3)=t0(1)*(-v(56)+v(65))+t0(3)*(v(51)+v(67))+t0(2)*(v(64)*v(86)+v(93))
     dt(3,1)=t0(2)*(-v(48)+v(65))+t0(1)*(v(50)+v(69))+t0(3)*(v(96)+v(60)*v(97))
     dt(3,2)=t0(1)*(-v(53)+v(65))+t0(2)*(-v(50)+v(66))+t0(3)*(v(101)+v(63)*v(97))
     dt(3,3)=v(346)*v(64)+t0(2)*(-v(51)+v(67))+t0(1)*(-v(55)+v(70))
  end if
  if(present(ddt))then
     ddt(1,1,1)=t0(2)*(v(202)+v(223))+t0(3)*(-v(203)+v(228))+v(162)*v(341)
     ddt(1,1,2)=v(293)
     ddt(1,1,3)=v(294)
     ddt(1,2,1)=v(293)
     ddt(1,2,2)=t0(3)*(v(164)+v(198))+t0(2)*(-v(179)+v(219))+t0(1)*(v(342)+v(161)*v(77))
     ddt(1,2,3)=v(302)
     ddt(1,3,1)=v(294)
     ddt(1,3,2)=v(302)
     ddt(1,3,3)=t0(2)*(v(165)+v(194))+t0(3)*(v(180)+v(225))+t0(1)*(v(343)+v(159)*v(77))
     ddt(2,1,1)=t0(3)*(v(163)+v(207))+t0(1)*(-v(202)+v(223))+t0(2)*(v(344)+v(162)*v(86))
     ddt(2,1,2)=v(296)
     ddt(2,1,3)=v(297)
     ddt(2,2,1)=v(296)
     ddt(2,2,2)=t0(1)*(v(179)+v(219))+t0(3)*(-v(196)+v(231))+v(161)*v(345)
     ddt(2,2,3)=v(304)
     ddt(2,3,1)=v(297)
     ddt(2,3,2)=v(304)
     ddt(2,3,3)=t0(1)*(v(165)-v(194))+t0(3)*(v(190)+v(230))+t0(2)*(v(343)+v(159)*v(86))
     ddt(3,1,1)=t0(2)*(v(163)-v(207))+t0(1)*(v(203)+v(228))+t0(3)*(v(344)+v(162)*v(97))
     ddt(3,1,2)=v(299)
     ddt(3,1,3)=v(300)
     ddt(3,2,1)=v(299)
     ddt(3,2,2)=t0(1)*(v(164)-v(198))+t0(2)*(v(196)+v(231))+t0(3)*(v(342)+v(161)*v(97))
     ddt(3,2,3)=v(306)
     ddt(3,3,1)=v(300)
     ddt(3,3,2)=v(306)
     ddt(3,3,3)=t0(1)*(-v(180)+v(225))+t0(2)*(-v(190)+v(230))+v(159)*v(346)
  end if
END SUBROUTINE director3d
